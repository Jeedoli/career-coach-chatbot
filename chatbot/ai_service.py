"""
ğŸ¤– AI ì„œë¹„ìŠ¤ - í•µì‹¬ ì°¨ë³„í™” ì—”ì§„

í‰ê°€ í¬ì¸íŠ¸ ì§‘ì¤‘:
1. LLM í”„ë¡¬í”„íŠ¸ ì—”ì§€ë‹ˆì–´ë§ - íš¨ê³¼ì ì´ê³  ë…ì°½ì 
2. ê°œì¸ ë§ì¶¤í˜• íŠ¹ì§• - ì§„ì§œ ë§ì¶¤í˜•
3. ì‹¤ìš©ì„± - ì‹¤ì œ ë„ì›€ì´ ë˜ëŠ”ê°€

ì°¨ë³„í™” ì „ëµ:
- ë‹¤ë‹¨ê³„ ë¶„ì„ í”„ë¡¬í”„íŠ¸ ì²´ì´ë‹
- ì‹¤ì œ ì±„ìš© ì‹œì¥ ë°ì´í„° ë°˜ì˜
- ê²½ë ¥ íŒ¨í„´ë³„ ë§ì¶¤í˜• ì ‘ê·¼
"""

import os
import json
import time
from typing import List, Dict, Any, Tuple
from dataclasses import dataclass
from openai import OpenAI

# í™˜ê²½ ë³€ìˆ˜ì—ì„œ API í‚¤ ê°€ì ¸ì˜¤ê¸°
client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))


@dataclass
class CareerAnalysis:
    """ì»¤ë¦¬ì–´ ë¶„ì„ ê²°ê³¼"""
    career_level: str
    strength_areas: List[str]
    improvement_areas: List[str]
    career_pattern: str
    market_competitiveness: int
    personality_traits: List[str]
    growth_trajectory: str


class CareerCoachAI:
    """ì»¤ë¦¬ì–´ ì½”ì¹˜ AI ì—”ì§„"""
    
    def __init__(self):
        self.model = "gpt-4o-mini"  # ë¹„ìš© íš¨ìœ¨ì ì´ë©´ì„œ ì„±ëŠ¥ ì¢‹ì€ ëª¨ë¸
        
    def analyze_resume_profile(self, career_summary: str, job_role: str, 
                             technical_skills: str, experience_years: int) -> CareerAnalysis:
        """
        ğŸ” 1ë‹¨ê³„: ì´ë ¥ì„œ ì‹¬ì¸µ ë¶„ì„
        - ë‹¨ìˆœ ì •ë³´ ì¶”ì¶œì´ ì•„ë‹Œ íŒ¨í„´ ë¶„ì„
        - ìˆ¨ê²¨ì§„ ê°•ì /ì•½ì  ë°œê²¬
        """
        
        analysis_prompt = f"""
ë‹¹ì‹ ì€ 20ë…„ ê²½ë ¥ì˜ ê¸€ë¡œë²Œ í—¤ë“œí—ŒíŒ… íšŒì‚¬ ì‹œë‹ˆì–´ íŒŒíŠ¸ë„ˆì…ë‹ˆë‹¤. 
êµ¬ê¸€, ë©”íƒ€, ë„¤ì´ë²„, ì¹´ì¹´ì˜¤ ë“± ìˆ˜ì²œ ëª…ì˜ ê°œë°œì ì±„ìš©ì„ ì„±ê³µì‹œí‚¤ë©°, ê°œë°œì ì»¤ë¦¬ì–´ íŒ¨í„´ê³¼ ì‹œì¥ íŠ¸ë Œë“œë¥¼ ì •í™•íˆ íŒŒì•…í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

**ì§€ì›ì ì •ë³´:**
ğŸ“‹ **ê²½ë ¥ ìš”ì•½**: {career_summary}
ğŸ’¼ **ìˆ˜í–‰ ì§ë¬´**: {job_role}
ğŸ› ï¸ **ê¸°ìˆ  ìŠ¤í‚¬**: {technical_skills}
ğŸ“… **ê²½ë ¥ ì—°ìˆ˜**: {experience_years}ë…„

**ë¯¸ì…˜**: ì´ ê°œë°œìì˜ í˜„ì¬ ìœ„ì¹˜ì™€ ì ì¬ë ¥ì„ ì •ë°€ ë¶„ì„í•˜ì—¬, í–¥í›„ ì»¤ë¦¬ì–´ ì „ëµ ìˆ˜ë¦½ì˜ ê¸°ì´ˆ ë°ì´í„°ë¥¼ ì œê³µí•˜ì„¸ìš”.

**ì‹¬ì¸µ ë¶„ì„ í•­ëª©:**

1. **ì»¤ë¦¬ì–´ ë ˆë²¨ ì •ë°€ ì§„ë‹¨**
   - ê²½ë ¥ ì—°ìˆ˜ ëŒ€ë¹„ ì‹¤ì œ ì„±ìˆ™ë„ í‰ê°€
   - ì—…ê³„ í‘œì¤€ê³¼ ë¹„êµí•œ ê¸°ìˆ  ìˆ˜ì¤€
   - ë¦¬ë”ì‹­/ì±…ì„ê° ë°œì „ ì •ë„

2. **ì‹œì¥ ì°¨ë³„í™” ê°•ì  ë¶„ì„** (êµ¬ì²´ì  ì¦ê±° ê¸°ë°˜)
   - íƒ€ ê°œë°œì ëŒ€ë¹„ ë…íŠ¹í•œ ê²½í—˜ì´ë‚˜ ì—­ëŸ‰
   - ê¸°ìˆ ì  ê¹Šì´ì™€ ë„“ì´ì˜ ê· í˜•
   - ë¹„ì¦ˆë‹ˆìŠ¤ ì„íŒ©íŠ¸ ì°½ì¶œ ëŠ¥ë ¥

3. **ì „ëµì  ê°œì„  ì˜ì—­** (ì±„ìš© ê´€ì )
   - í˜„ì¬ ì‹œì¥ì—ì„œ ìš”êµ¬ë˜ì§€ë§Œ ë¶€ì¡±í•œ ìŠ¤í‚¬
   - ë‹¤ìŒ ë ˆë²¨ë¡œ ìŠ¹ì§„í•˜ê¸° ìœ„í•œ í•„ìˆ˜ ì—­ëŸ‰
   - ì¥ê¸°ì  ê²½ìŸë ¥ í™•ë³´ë¥¼ ìœ„í•œ íˆ¬ì ì˜ì—­

4. **ì»¤ë¦¬ì–´ ì„±í–¥ ë° ë™ê¸°** 
   - ì•ˆì • ì¶”êµ¬í˜• vs ë„ì „ ì§€í–¥í˜•
   - ê¸°ìˆ  ì „ë¬¸ê°€í˜• vs ê´€ë¦¬ìí˜•
   - ê°œì¸ ì„±ê³¼í˜• vs íŒ€ ê¸°ì—¬í˜•

5. **í˜„ì¬ ì‹œì¥ ê°€ì¹˜** (ì •ëŸ‰ì  í‰ê°€)
   - í˜„ì¬ ê¸°ìˆ  ìŠ¤íƒì˜ ì‹œì¥ ìˆ˜ìš”ë„
   - ê²½ë ¥ ëŒ€ë¹„ ì—°ë´‰ í˜‘ìƒë ¥
   - ì´ì§ ì‹œ ì„ íƒê¶Œì˜ í­

6. **ì„±ê²© ë° ì—…ë¬´ ìŠ¤íƒ€ì¼** (ì´ë ¥ì„œ íŒ¨í„´ ë¶„ì„)
   - í•™ìŠµ ì§€í–¥ì„±ê³¼ ì ì‘ë ¥
   - ì†Œí†µ ë°©ì‹ê³¼ í˜‘ì—… ì„±í–¥
   - ë„ì „ê³¼ ì•ˆì •ì— ëŒ€í•œ íƒœë„

7. **5ë…„ í›„ ì„±ì¥ ì‹œë‚˜ë¦¬ì˜¤**
   - í˜„ì¬ ê¶¤ì  ìœ ì§€ ì‹œ ë„ë‹¬ ì§€ì 
   - ìµœì  ì„±ì¥ ì „ëµ ìˆ˜ë¦½ ì‹œ ê°€ëŠ¥ì„±
   - ì‹œì¥ ë³€í™”ì— ë”°ë¥¸ ë¦¬ìŠ¤í¬ì™€ ê¸°íšŒ

**ì¶œë ¥ í˜•ì‹ (JSON):**
{{
    "career_level": "ì£¼ë‹ˆì–´/ì¤‘ê¸‰/ì‹œë‹ˆì–´/ë¦¬ë“œ/ì•„í‚¤í…íŠ¸ ì¤‘ ì •í™•í•œ ìœ„ì¹˜",
    "strength_areas": [
        "êµ¬ì²´ì ì´ê³  ì°¨ë³„í™”ëœ ê°•ì  1",
        "ì‹œì¥ì—ì„œ ì¸ì •ë°›ì„ ìˆ˜ ìˆëŠ” ê°•ì  2", 
        "ê²½ìŸ ìš°ìœ„ë¥¼ ë§Œë“œëŠ” ê°•ì  3"
    ],
    "improvement_areas": [
        "ë‹¤ìŒ ë ˆë²¨ ìŠ¹ì§„ì„ ìœ„í•œ í•„ìˆ˜ ê°œì„ ì‚¬í•­ 1",
        "ì‹œì¥ ìš”êµ¬ì‚¬í•­ ëŒ€ë¹„ ë¶€ì¡±í•œ ì˜ì—­ 2",
        "ì¥ê¸° ê²½ìŸë ¥ì„ ìœ„í•œ íˆ¬ì ì˜ì—­ 3"
    ],
    "career_pattern": "ì´ ê°œë°œìì˜ ì„±ì¥ íŒ¨í„´ê³¼ ì»¤ë¦¬ì–´ ì¶”ì§„ë ¥ì— ëŒ€í•œ ì •ë°€ ë¶„ì„ (3-4ë¬¸ì¥ìœ¼ë¡œ êµ¬ì²´ì  ê·¼ê±° í¬í•¨)",
    "market_competitiveness": "í˜„ì¬ ì‹œì¥ì—ì„œì˜ ê²½ìŸë ¥ ì ìˆ˜ (1-10ì , ë™ì¼ ê²½ë ¥ ëŒ€ë¹„)",
    "personality_traits": [
        "ì´ë ¥ì„œì—ì„œ ë“œëŸ¬ë‚˜ëŠ” í•™ìŠµ/ì„±ì¥ ì„±í–¥",
        "ì—…ë¬´ ì ‘ê·¼ ë°©ì‹ (ì²´ê³„ì /ì°½ì˜ì /ì‹¤ìš©ì  ë“±)",
        "íŒ€ì›Œí¬ ë° ë¦¬ë”ì‹­ ì ì¬ë ¥"
    ],
    "growth_trajectory": "í˜„ì¬ ê²½ë¡œ ìœ ì§€ ì‹œë‚˜ë¦¬ì˜¤ì™€ ìµœì  ì„±ì¥ ì „ëµ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¹„êµí•œ 5ë…„ í›„ ì „ë§ (3-4ë¬¸ì¥)"
}}

**ë¶„ì„ ì‹œ ê³ ë ¤ì‚¬í•­:**
- ê¸°ìˆ  ìŠ¤íƒì˜ íŠ¸ë Œë“œì™€ ì‹œì¥ ìˆ˜ìš” ë°˜ì˜
- íšŒì‚¬ ê·œëª¨/ìœ í˜•ë³„ ì„ í˜¸ë„ ì°¨ì´ ê³ ë ¤  
- ê°œë°œì ì»¤ë¦¬ì–´ ë‹¨ê³„ë³„ ì „í˜•ì  íŒ¨í„´ê³¼ ë¹„êµ
- ì‹¤ì œ ì±„ìš© í˜„ì¥ì—ì„œì˜ í‰ê°€ ê¸°ì¤€ ì ìš©

**ì£¼ì˜**: ì¶”ìƒì ì´ê±°ë‚˜ ì¼ë°˜ì ì¸ ë¶„ì„ ê¸ˆì§€. êµ¬ì²´ì  ê·¼ê±°ì™€ ì‹¤ìš©ì  ì¸ì‚¬ì´íŠ¸ ì¤‘ì‹¬ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
"""

        try:
            response = client.chat.completions.create(
                model=self.model,
                messages=[{"role": "user", "content": analysis_prompt}],
                temperature=0.3,  # ì¼ê´€ì„± ìˆëŠ” ë¶„ì„ì„ ìœ„í•´ ë‚®ì€ temperature
                max_tokens=1500
            )
            
            # ë””ë²„ê¹…: ì›ì‹œ ì‘ë‹µ í™•ì¸
            raw_content = response.choices[0].message.content
            print(f"ğŸ” OpenAI ì›ì‹œ ì‘ë‹µ: {raw_content}")
            
            # JSON íŒŒì‹± ì „ ì •ë¦¬
            if raw_content:
                # ì½”ë“œ ë¸”ë¡ ë§ˆì»¤ ì œê±°
                if raw_content.startswith("```json"):
                    raw_content = raw_content[7:]
                if raw_content.endswith("```"):
                    raw_content = raw_content[:-3]
                raw_content = raw_content.strip()
                
                result = json.loads(raw_content)
            else:
                raise ValueError("Empty response from OpenAI")
            
            return CareerAnalysis(
                career_level=result['career_level'],
                strength_areas=result['strength_areas'],
                improvement_areas=result['improvement_areas'],
                career_pattern=result['career_pattern'],
                market_competitiveness=result['market_competitiveness'],
                personality_traits=result['personality_traits'],
                growth_trajectory=result['growth_trajectory']
            )
            
        except json.JSONDecodeError as e:
            # JSON íŒŒì‹± ì˜¤ë¥˜ ìƒì„¸ ë¡œê¹…
            print(f"âŒ JSON íŒŒì‹± ì˜¤ë¥˜: {e}")
            print(f"ğŸ” ë¬¸ì œê°€ ëœ ì‘ë‹µ ë‚´ìš©: {raw_content}")
            
            # JSON ë³µêµ¬ ì‹œë„
            try:
                # ë¶ˆì™„ì „í•œ JSONì„ ì™„ì„±í•˜ë ¤ê³  ì‹œë„
                if "{" in raw_content:
                    start_idx = raw_content.find("{")
                    json_part = raw_content[start_idx:]
                    # ì¤‘ê´„í˜¸ ê· í˜• ë§ì¶”ê¸°
                    open_count = json_part.count("{")
                    close_count = json_part.count("}")
                    if open_count > close_count:
                        json_part += "}" * (open_count - close_count)
                    result = json.loads(json_part)
                else:
                    raise ValueError("No JSON structure found")
            except:
                # ì™„ì „íˆ ì‹¤íŒ¨í•œ ê²½ìš° ê¸°ë³¸ê°’ ì‚¬ìš©
                result = {
                    "career_level": "ë¶„ì„ ì¤‘",
                    "strength_areas": ["ê¸°ìˆ ì  ì—­ëŸ‰", "ì‹¤ë¬´ ê²½í—˜"],
                    "improvement_areas": ["ì¶”ê°€ ë¶„ì„ í•„ìš”"],
                    "career_pattern": "ë¶„ì„ ì§„í–‰ ì¤‘",
                    "market_competitiveness": 5,
                    "personality_traits": ["ë¶„ì„ ì¤‘"],
                    "growth_trajectory": "ì¶”ê°€ ë¶„ì„ í•„ìš”"
                }
            
            return CareerAnalysis(
                career_level=result['career_level'],
                strength_areas=result['strength_areas'],
                improvement_areas=result['improvement_areas'],
                career_pattern=result['career_pattern'],
                market_competitiveness=result['market_competitiveness'],
                personality_traits=result['personality_traits'],
                growth_trajectory=result['growth_trajectory']
            )
            
        except Exception as e:
            # ì™„ì „í•œ API í˜¸ì¶œ ì‹¤íŒ¨
            print(f"âŒ OpenAI API í˜¸ì¶œ ì˜¤ë¥˜: {e}")
            print(f"API í‚¤ ì„¤ì • ì—¬ë¶€: {'ì„¤ì •ë¨' if os.getenv('OPENAI_API_KEY') else 'ë¯¸ì„¤ì •'}")
            
            # ê¸°ë³¸ê°’ ë°˜í™˜ (ì—ëŸ¬ í•¸ë“¤ë§)
            return CareerAnalysis(
                career_level="ë¶„ì„ ì¤‘",
                strength_areas=["ê¸°ìˆ ì  ì—­ëŸ‰"],
                improvement_areas=["ì¶”ê°€ ë¶„ì„ í•„ìš”"],
                career_pattern="ë¶„ì„ ì§„í–‰ ì¤‘",
                market_competitiveness=5,
                personality_traits=["ë¶„ì„ ì¤‘"],
                growth_trajectory="ì¶”ê°€ ë¶„ì„ í•„ìš”"
            )

    def generate_interview_questions(self, analysis: CareerAnalysis, 
                                   company_type: str, position_level: str,
                                   career_summary: str, technical_skills: str) -> List[Dict[str, str]]:
        """
        ğŸ¯ 2ë‹¨ê³„: ë§ì¶¤í˜• ë©´ì ‘ ì§ˆë¬¸ ìƒì„±
        - ë¶„ì„ ê²°ê³¼ ê¸°ë°˜ ê°œì¸í™”
        - íšŒì‚¬ ìœ í˜•ë³„ ì°¨ë³„í™”
        - ì‹¤ì œ ë©´ì ‘ì—ì„œ ë‚˜ì˜¬ ë²•í•œ ì§ˆë¬¸
        """
        
        # íšŒì‚¬ ìœ í˜•ë³„ ë©´ì ‘ ìŠ¤íƒ€ì¼ ì •ì˜
        company_styles = {
            "startup": "ë¹ ë¥¸ ì„±ì¥, ë‹¤ì–‘í•œ ì—­í• , ë¬¸ì œí•´ê²° ëŠ¥ë ¥ ì¤‘ì‹œ",
            "midsize": "ì•ˆì •ì„±ê³¼ ì„±ì¥ì˜ ê· í˜•, ì²´ê³„ì  í”„ë¡œì„¸ìŠ¤",
            "large": "ì „ë¬¸ì„±, ì²´ê³„ì  ì—…ë¬´, í˜‘ì—… ëŠ¥ë ¥",
            "foreign": "ê¸€ë¡œë²Œ ë§ˆì¸ë“œ, ì»¤ë®¤ë‹ˆì¼€ì´ì…˜, ë‹¤ì–‘ì„±"
        }
        
        interview_prompt = f"""
ë‹¹ì‹ ì€ {company_styles.get(company_type, "ì¼ë°˜ ê¸°ì—…")} íŠ¹ì„±ì„ ê°€ì§„ íšŒì‚¬ì˜ ì‹œë‹ˆì–´ ê¸°ìˆ  ë©´ì ‘ê´€ì…ë‹ˆë‹¤. 
10ë…„ ì´ìƒ {position_level} ë ˆë²¨ ê°œë°œìë¥¼ ì±„ìš©í•´ì˜¨ ì „ë¬¸ê°€ë¡œ, ì‹¤ì œ ì—…ë¬´ ì—­ëŸ‰ì„ ì •í™•íˆ íŒŒì•…í•˜ëŠ” ë‚ ì¹´ë¡œìš´ ì§ˆë¬¸ìœ¼ë¡œ ìœ ëª…í•©ë‹ˆë‹¤.

**ì§€ì›ì ìƒì„¸ í”„ë¡œí•„:**
- ì»¤ë¦¬ì–´ ë ˆë²¨: {analysis.career_level}
- í•µì‹¬ ê°•ì : {', '.join(analysis.strength_areas)}
- ê°œì„  í•„ìš” ì˜ì—­: {', '.join(analysis.improvement_areas)}
- ì„±ê²© íŠ¹ì„±: {', '.join(analysis.personality_traits)}
- êµ¬ì²´ì  ê²½ë ¥: {career_summary}
- ê¸°ìˆ  ìŠ¤íƒ: {technical_skills}

**ë©´ì ‘ ëª©í‘œ**: ì´ ì§€ì›ìê°€ ìš°ë¦¬ íšŒì‚¬ {position_level} í¬ì§€ì…˜ì—ì„œ **ì‹¤ì œë¡œ ì„±ê³¼ë¥¼ ë‚¼ ìˆ˜ ìˆëŠ”ì§€** ê²€ì¦í•˜ëŠ” ì‹¬ì¸µ ì§ˆë¬¸ì„ ë§Œë“œì„¸ìš”.

**í•„ìˆ˜ ì§ˆë¬¸ ì„¤ê³„ ì›ì¹™:**
1. **ê²½í—˜ ê¸°ë°˜ êµ¬ì²´ì„±**: ì§€ì›ìì˜ ì‹¤ì œ í”„ë¡œì íŠ¸/ê¸°ìˆ ì„ ì–¸ê¸‰í•œ ì„¸ë¶€ ì§ˆë¬¸
2. **ì‹¤ë¬´ ì‹œë‚˜ë¦¬ì˜¤**: ê°€ìƒì´ ì•„ë‹Œ ì‹¤ì œ ì¼ì–´ë‚  ìˆ˜ ìˆëŠ” ì—…ë¬´ ìƒí™©
3. **ê¸°ìˆ ì  ê¹Šì´**: ë‹¨ìˆœ ì§€ì‹ì´ ì•„ë‹Œ ë¬¸ì œ í•´ê²° ê³¼ì •ê³¼ íŠ¸ë ˆì´ë“œì˜¤í”„ ì´í•´ë„ í‰ê°€
4. **í˜‘ì—… ê²€ì¦**: ì‹¤ì œ íŒ€ì›Œí¬ì™€ ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ì—­ëŸ‰ í™•ì¸
5. **íšŒì‚¬ í•**: {company_type} í™˜ê²½ì—ì„œì˜ ì ì‘ë ¥ê³¼ ê°€ì¹˜ ë¶€í•©ì„±

**í•„ìˆ˜ ì§ˆë¬¸ ì¹´í…Œê³ ë¦¬ (ê° 1ê°œì”©, ì´ 5ê°œ):**

1. **ê¸°ìˆ  ì „ë¬¸ì„± & ì‹¤ë¬´ ê²½í—˜** (ê³ ê¸‰ ë‚œì´ë„)
   - ì§€ì›ìì˜ ì£¼ìš” ê¸°ìˆ  ìŠ¤íƒì„ ê¹Šì´ ìˆê²Œ íƒêµ¬
   - ì‹¤ì œ ê²ªì—ˆì„ ë²•í•œ ê¸°ìˆ ì  ë„ì „ê³¼ í•´ê²° ê³¼ì •
   - ì•„í‚¤í…ì²˜/ì„¤ê³„ ê´€ë ¨ ì˜ì‚¬ê²°ì • ê²½í—˜

2. **ë¬¸ì œ í•´ê²° & íŠ¸ëŸ¬ë¸”ìŠˆíŒ…** (ì¤‘ê¸‰-ê³ ê¸‰ ë‚œì´ë„)
   - êµ¬ì²´ì ì¸ ë¬¸ì œ ìƒí™©ê³¼ í•´ê²° ê³¼ì •
   - ë‹¤ì–‘í•œ ì ‘ê·¼ë²•ì˜ ì¥ë‹¨ì  ë¶„ì„
   - ì œì•½ ì¡°ê±´ í•˜ì—ì„œì˜ ìµœì í•´ ë„ì¶œ

3. **í•™ìŠµ ëŠ¥ë ¥ & ì ì‘ë ¥** (ì¤‘ê¸‰ ë‚œì´ë„)
   - ìƒˆë¡œìš´ ê¸°ìˆ  ìŠµë“ ê²½í—˜ê³¼ ë°©ë²•ë¡ 
   - ì‹¤íŒ¨ë‚˜ ì–´ë ¤ì›€ ê·¹ë³µ ì‚¬ë¡€
   - ë³€í™”í•˜ëŠ” ìš”êµ¬ì‚¬í•­ì— ëŒ€í•œ ëŒ€ì‘

4. **íŒ€ì›Œí¬ & ì»¤ë®¤ë‹ˆì¼€ì´ì…˜** (ì¤‘ê¸‰ ë‚œì´ë„)
   - ì‹¤ì œ í˜‘ì—… ê²½í—˜ê³¼ ê°ˆë“± í•´ê²°
   - ê¸°ìˆ ì  ë‚´ìš©ì˜ ë¹„ê¸°ìˆ ì ì„¤ëª… ëŠ¥ë ¥
   - ì½”ë“œ ë¦¬ë·°, ë©˜í† ë§ ë“± ì§€ì‹ ê³µìœ  ê²½í—˜

5. **íšŒì‚¬ ì í•©ì„± & ë¹„ì „** (ê¸°ë³¸-ì¤‘ê¸‰ ë‚œì´ë„)
   - {company_type} í™˜ê²½ì—ì„œì˜ ëª©í‘œì™€ ê¸°ì—¬ ë°©í–¥
   - ì¥ê¸°ì  ì„±ì¥ ê³„íšê³¼ íšŒì‚¬ ë°œì „ ë°©í–¥ì˜ ì¼ì¹˜ì„±
   - ì—…ë¬´ ìš°ì„ ìˆœìœ„ì™€ ê°€ì¹˜ê´€

**ì¶œë ¥ í˜•ì‹ (JSON):**
[
    {{
        "question": "ì§€ì›ìì˜ êµ¬ì²´ì  ê²½í—˜ì„ ì–¸ê¸‰í•œ ìƒì„¸í•˜ê³  ë‚ ì¹´ë¡œìš´ ì§ˆë¬¸ (2-3ë¬¸ì¥)",
        "category": "ê¸°ìˆ  ì „ë¬¸ì„± & ì‹¤ë¬´ ê²½í—˜",
        "difficulty_level": "ê³ ê¸‰",
        "suggested_answer_approach": "íš¨ê³¼ì ì¸ ë‹µë³€ì„ ìœ„í•œ êµ¬ì²´ì  ê°€ì´ë“œ (êµ¬ì¡°í™” ë°©ë²•, í¬í•¨í•  ë‚´ìš© ë“±)"
    }},
    {{
        "question": "ì‹¤ì œ ìƒí™© ê¸°ë°˜ì˜ ë¬¸ì œ í•´ê²° ì‹œë‚˜ë¦¬ì˜¤ ì§ˆë¬¸",
        "category": "ë¬¸ì œ í•´ê²° & íŠ¸ëŸ¬ë¸”ìŠˆíŒ…", 
        "difficulty_level": "ì¤‘ê¸‰",
        "suggested_answer_approach": "ë¬¸ì œ ë¶„ì„ -> í•´ê²° ê³¼ì • -> ê²°ê³¼ -> í•™ìŠµ ìˆœì„œë¡œ ë‹µë³€"
    }}
    // ... ì´ 5ê°œ ì§ˆë¬¸
]

**ì£¼ì˜ì‚¬í•­:**
- ê° ì§ˆë¬¸ì€ ì§€ì›ìì˜ ì‹¤ì œ ê²½í—˜ê³¼ ê¸°ìˆ ì„ êµ¬ì²´ì ìœ¼ë¡œ ì–¸ê¸‰í•´ì•¼ í•¨
- "ì¼ë°˜ì ìœ¼ë¡œ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?" ê°™ì€ ì¶”ìƒì  ì§ˆë¬¸ ê¸ˆì§€
- ì‹¤ì œ ë©´ì ‘ì—ì„œ 30ë¶„ ì´ìƒ í† ë¡ í•  ìˆ˜ ìˆì„ ì •ë„ì˜ ê¹Šì´ ìˆëŠ” ì§ˆë¬¸
- {company_type} íšŒì‚¬ì˜ íŠ¹ì„±ê³¼ {position_level} ë ˆë²¨ì— ì í•©í•œ ë‚œì´ë„
"""

        try:
            response = client.chat.completions.create(
                model=self.model,
                messages=[{"role": "user", "content": interview_prompt}],
                temperature=0.7,  # ì°½ì˜ì  ì§ˆë¬¸ ìƒì„±ì„ ìœ„í•´ ë†’ì€ temperature
                max_tokens=2000
            )
            
            # JSON íŒŒì‹± ê°œì„ 
            raw_content = response.choices[0].message.content
            print(f"ğŸ” ë©´ì ‘ ì§ˆë¬¸ ì›ì‹œ ì‘ë‹µ: {raw_content}")
            
            # JSON ì •ë¦¬
            if raw_content.startswith("```json"):
                raw_content = raw_content[7:]
            if raw_content.endswith("```"):
                raw_content = raw_content[:-3]
            raw_content = raw_content.strip()
            
            questions = json.loads(raw_content)
            return questions[:5]  # ì •í™•íˆ 5ê°œë§Œ ë°˜í™˜
            
        except json.JSONDecodeError as e:
            print(f"âŒ ë©´ì ‘ ì§ˆë¬¸ JSON íŒŒì‹± ì˜¤ë¥˜: {e}")
            print(f"ğŸ” ë¬¸ì œê°€ ëœ ì‘ë‹µ: {raw_content}")
            # ê¸°ë³¸ ì§ˆë¬¸ ë°˜í™˜
        except Exception as e:
            print(f"âŒ ë©´ì ‘ ì§ˆë¬¸ ìƒì„± ì˜¤ë¥˜: {e}")
            # ê¸°ë³¸ ì§ˆë¬¸ ë°˜í™˜
            # ê¸°ë³¸ ì§ˆë¬¸ ë°˜í™˜ (ì—ëŸ¬ í•¸ë“¤ë§)
            return [
                {
                    "question": "ë³¸ì¸ì˜ ì£¼ìš” í”„ë¡œì íŠ¸ ê²½í—˜ì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”.",
                    "category": "ê²½í—˜",
                    "difficulty_level": "ê¸°ë³¸",
                    "suggested_answer_approach": "êµ¬ì²´ì ì¸ ì„±ê³¼ì™€ í•™ìŠµ í¬ì¸íŠ¸ ì¤‘ì‹¬ìœ¼ë¡œ ë‹µë³€"
                }
            ] * 5

    def generate_learning_path(self, analysis: CareerAnalysis, target_goal: str,
                             career_summary: str, technical_skills: str,
                             duration_months: int = 3) -> List[Dict[str, Any]]:
        """
        ğŸ“š 3ë‹¨ê³„: ê°œì¸ ë§ì¶¤í˜• í•™ìŠµ ê²½ë¡œ ìƒì„±
        - í˜„ì¬ ìˆ˜ì¤€ì—ì„œ ëª©í‘œê¹Œì§€ì˜ êµ¬ì²´ì  ë¡œë“œë§µ
        - ì‹¤í˜„ ê°€ëŠ¥í•œ ë‹¨ê³„ë³„ ê³„íš
        """
        
        goal_descriptions = {
            "skill_enhancement": "í˜„ì¬ ê¸°ìˆ  ìŠ¤í‚¬ ì‹¬í™” ë° í™•ì¥",
            "career_change": "ìƒˆë¡œìš´ ë¶„ì•¼ë¡œì˜ ì»¤ë¦¬ì–´ ì „í™˜",
            "promotion": "í˜„ì¬ ì§ë¬´ì—ì„œì˜ ìŠ¹ì§„ ë° ì„±ì¥",
            "interview_prep": "ë©´ì ‘ ì¤€ë¹„ ë° ì·¨ì—… ì„±ê³µ"
        }
        
        learning_prompt = f"""
ë‹¹ì‹ ì€ 10ë…„ ì´ìƒ ê°œë°œì ì»¤ë¦¬ì–´ ì½”ì¹­ì„ í•´ì˜¨ ì‹œë‹ˆì–´ ë©˜í† ì…ë‹ˆë‹¤. ì‹¤ë¦¬ì½˜ë°¸ë¦¬ì™€ êµ­ë‚´ ëŒ€ê¸°ì—…ì—ì„œ ìˆ˜ë°± ëª…ì˜ ê°œë°œì ì„±ì¥ì„ ë„ì™”ìŠµë‹ˆë‹¤.

**ì§€ì›ì ì‹¬ì¸µ ë¶„ì„:**
- ì»¤ë¦¬ì–´ ë ˆë²¨: {analysis.career_level}
- í•µì‹¬ ê°•ì : {', '.join(analysis.strength_areas)}
- ê°œì„  í•„ìš” ì˜ì—­: {', '.join(analysis.improvement_areas)}
- ì„±ì¥ ê¶¤ì : {analysis.growth_trajectory}
- í˜„ì¬ ê¸°ìˆ  ìŠ¤íƒ: {technical_skills}
- ì»¤ë¦¬ì–´ ëª©í‘œ: {goal_descriptions.get(target_goal, target_goal)}
- í•™ìŠµ ê¸°ê°„: {duration_months}ê°œì›”

**ë¯¸ì…˜**: ì´ ê°œë°œìê°€ ì‹œì¥ì—ì„œ ê²½ìŸë ¥ì„ ê°–ì¶”ê³  ì»¤ë¦¬ì–´ ëª©í‘œë¥¼ ë‹¬ì„±í•  ìˆ˜ ìˆëŠ” **ì‹¤ì „ ì¤‘ì‹¬ì˜ í•™ìŠµ ë¡œë“œë§µ**ì„ ì„¤ê³„í•˜ì„¸ìš”.

**í•„ìˆ˜ í¬í•¨ ìš”ì†Œ:**
1. **íŠ¹ì • ê¸°ìˆ  ìŠ¤íƒ ì‹¬í™”**: í˜„ì¬ ê¸°ìˆ ì„ ì „ë¬¸ê°€ ìˆ˜ì¤€ìœ¼ë¡œ ë°œì „
2. **ê´€ë ¨ í”„ë¡œì íŠ¸ ê²½í—˜**: ì‹¤ì œ í¬íŠ¸í´ë¦¬ì˜¤ê°€ ë  ìˆ˜ ìˆëŠ” í”„ë¡œì íŠ¸
3. **ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ìŠ¤í‚¬**: ê¸°ìˆ  ë°œí‘œ, ì½”ë“œ ë¦¬ë·°, íŒ€ í˜‘ì—… ì—­ëŸ‰
4. **ì‹œì¥ íŠ¸ë Œë“œ ë°˜ì˜**: ìµœì‹  ê¸°ìˆ  ë™í–¥ê³¼ ì±„ìš© ìš”êµ¬ì‚¬í•­

**ë¡œë“œë§µ ì„¤ê³„ ì›ì¹™:**
- **ì‹¤ë¬´ ì—°ê²°ì„±**: ì‹¤ì œ ì—…ë¬´ì—ì„œ ë°”ë¡œ ì¨ë¨¹ì„ ìˆ˜ ìˆëŠ” ë‚´ìš©
- **í”„ë¡œì íŠ¸ ê¸°ë°˜**: ê° ë‹¨ê³„ë§ˆë‹¤ êµ¬ì²´ì ì¸ ì‚°ì¶œë¬¼ ìƒì„±
- **ë„¤íŠ¸ì›Œí‚¹ í¬í•¨**: ê°œë°œ ì»¤ë®¤ë‹ˆí‹° ì°¸ì—¬ì™€ ì§€ì‹ ê³µìœ 
- **ì¸¡ì • ê°€ëŠ¥**: ì •ëŸ‰ì  í‰ê°€ê°€ ê°€ëŠ¥í•œ ëª…í™•í•œ ëª©í‘œ

**ë‹¨ê³„ë³„ ë¡œë“œë§µ (JSON):**
[
    {{
        "phase": "1ë‹¨ê³„: ê¸°ìˆ  ì „ë¬¸ì„± ì‹¬í™”",
        "duration_weeks": {duration_months * 4 // 3},
        "objectives": [
            "í˜„ì¬ ì£¼ë ¥ ê¸°ìˆ  ìŠ¤íƒì˜ ê³ ê¸‰ ê¸°ëŠ¥ ë§ˆìŠ¤í„°",
            "ì„±ëŠ¥ ìµœì í™” ë° ì•„í‚¤í…ì²˜ ì„¤ê³„ ëŠ¥ë ¥ í–¥ìƒ",
            "ì‹¤ì „ í”„ë¡œì íŠ¸ 1ê°œ ì™„ì„± (í¬íŠ¸í´ë¦¬ì˜¤ìš©)"
        ],
        "resources": [
            "ê¸°ìˆ ë³„ ê³µì‹ ë¬¸ì„œ ì‹¬í™” í•™ìŠµ (Spring Boot/Django ê³µì‹ ë¬¸ì„œ)",
            "ì‹¤ë¬´ ì•„í‚¤í…ì²˜ íŒ¨í„´ ì„œì  (í´ë¦° ì•„í‚¤í…ì²˜, ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ íŒ¨í„´)",
            "GitHub ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡œì íŠ¸ ë¶„ì„ (Spring Boot/Django ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤)"
        ],
        "milestones": [
            "ë³µì¡í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ í¬í•¨í•œ ê°œì¸ í”„ë¡œì íŠ¸ ì™„ì„±",
            "ê¸°ìˆ  ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… 3íšŒ ì´ìƒ",
            "ì½”ë“œ í’ˆì§ˆ ì¸¡ì • ë„êµ¬ë¡œ 80% ì´ìƒ ë‹¬ì„±"
        ]
    }},
    {{
        "phase": "2ë‹¨ê³„: í™•ì¥ ê¸°ìˆ  ìŠµë“ ë° ì‹¤ì „ ê²½í—˜",
        "duration_weeks": {duration_months * 4 // 2},
        "objectives": [
            "ì¸ì ‘ ê¸°ìˆ  ìŠ¤íƒ ìŠµë“ (í’€ìŠ¤íƒ/í´ë¼ìš°ë“œ/ë°ë¸Œì˜µìŠ¤)",
            "íŒ€ í”„ë¡œì íŠ¸ ë˜ëŠ” ì˜¤í”ˆì†ŒìŠ¤ ê¸°ì—¬ ê²½í—˜",
            "ê¸°ìˆ  ë°œí‘œ ë° ì§€ì‹ ê³µìœ  í™œë™"
        ],
        "resources": [
            "í´ë¼ìš°ë“œ í”Œë«í¼ ì‹¤ìŠµ ê³¼ì • (AWS/GCP ê³µì‹ íŠ¸ë ˆì´ë‹)",
            "ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡œì íŠ¸ ì°¸ì—¬ (ì¢‹ì€ ì²« ì´ìŠˆë¥¼ ì œê³µí•˜ëŠ” í”„ë¡œì íŠ¸ ì°¾ê¸°)",
            "ê°œë°œì ë°‹ì—… ë° ì»¨í¼ëŸ°ìŠ¤ ì°¸ì„ (Meetup.com, ê°œë°œì ì»¤ë®¤ë‹ˆí‹°)"
        ],
        "milestones": [
            "ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡œì íŠ¸ì— ì˜ë¯¸ìˆëŠ” ê¸°ì—¬ (PR ë¨¸ì§€)",
            "ê°œë°œì ì»¤ë®¤ë‹ˆí‹°ì—ì„œ ê¸°ìˆ  ë°œí‘œ 1íšŒ",
            "í´ë¼ìš°ë“œ ê¸°ë°˜ ë°°í¬ í™˜ê²½ êµ¬ì¶• ì™„ë£Œ"
        ]
    }},
    {{
        "phase": "3ë‹¨ê³„: ë¦¬ë”ì‹­ ë° ì˜í–¥ë ¥ í™•ì¥",
        "duration_weeks": {duration_months * 4 - (duration_months * 4 // 3) - (duration_months * 4 // 2)},
        "objectives": [
            "ì£¼ë‹ˆì–´ ê°œë°œì ë©˜í† ë§ ê²½í—˜",
            "ê¸°ìˆ ì  ì˜ì‚¬ê²°ì • ë° ì½”ë“œ ë¦¬ë·° ë¦¬ë”ì‹­",
            "ê°œë°œ í”„ë¡œì„¸ìŠ¤ ê°œì„  ì œì•ˆ ë° ì‹¤í–‰"
        ],
        "resources": [
            "ë¦¬ë”ì‹­ ë° ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ìŠ¤í‚¬ ë„ì„œ (í¬ë£¨ì…œ ëŒ€í™”, í”¼ë“œë°±ì˜ ê¸°ìˆ )",
            "ì½”ë“œ ë¦¬ë·° ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ í•™ìŠµ (Googleì˜ ì—”ì§€ë‹ˆì–´ë§ ë¬¸í™”)",
            "ì• ìì¼/ìŠ¤í¬ëŸ¼ ë°©ë²•ë¡  ì‹¤ìŠµ (Scrum.org ì¸ì¦ ê³¼ì •)"
        ],
        "milestones": [
            "1ëª… ì´ìƒ ì£¼ë‹ˆì–´ ê°œë°œì ë©˜í† ë§",
            "íŒ€/íšŒì‚¬ ë‚´ ê¸°ìˆ  ì„¸ë¯¸ë‚˜ ì§„í–‰",
            "ê°œë°œ í”„ë¡œì„¸ìŠ¤ ê°œì„  ì‚¬ë¡€ 1ê±´ ì´ìƒ"
        ]
    }}
]

**ì¶”ê°€ ê³ ë ¤ì‚¬í•­:**
- ê° ë‹¨ê³„ë³„ êµ¬ì²´ì ì¸ í”„ë¡œì íŠ¸ ì£¼ì œ ì œì•ˆ
- ì‹¤ì œ ì¡´ì¬í•˜ëŠ” í•™ìŠµ ìë£Œì™€ í”Œë«í¼ ì¶”ì²œ (ë¬¸ìì—´ë¡œ ê°„ë‹¨íˆ í‘œí˜„)
- ë„¤íŠ¸ì›Œí‚¹ ê¸°íšŒì™€ ì»¤ë®¤ë‹ˆí‹° ì°¸ì—¬ ë°©ë²•
- ì •ê¸°ì ì¸ ì§„í–‰ ìƒí™© ì ê²€ ë°©ë²•

**ì¤‘ìš” ì¶œë ¥ ê·œì¹™:**
- resourcesëŠ” ë°˜ë“œì‹œ ë¬¸ìì—´ ë°°ì—´ë¡œë§Œ ì¶œë ¥ (ê°ì²´ í˜•íƒœ ê¸ˆì§€)
- êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë‚´ìš©ìœ¼ë¡œ ì‘ì„±
- ê° ë‹¨ê³„ëŠ” ì‹¤ë¬´ì—ì„œ ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ ìˆ˜ì¤€
"""

        try:
            response = client.chat.completions.create(
                model=self.model,
                messages=[{"role": "user", "content": learning_prompt}],
                temperature=0.4,  # ì‹¤ìš©ì ì´ë©´ì„œ ì°½ì˜ì ì¸ ê³„íš
                max_tokens=2500
            )
            
            # JSON íŒŒì‹± ê°œì„ 
            raw_content = response.choices[0].message.content
            print(f"ğŸ” í•™ìŠµ ê²½ë¡œ ì›ì‹œ ì‘ë‹µ: {raw_content}")
            
            # JSON ë¶€ë¶„ë§Œ ì¶”ì¶œ
            if "```json" in raw_content:
                start_idx = raw_content.find("```json") + 7
                end_idx = raw_content.find("```", start_idx)
                if end_idx != -1:
                    raw_content = raw_content[start_idx:end_idx]
            elif "[" in raw_content:
                # JSON ë°°ì—´ ë¶€ë¶„ë§Œ ì¶”ì¶œ
                start_idx = raw_content.find("[")
                end_idx = raw_content.rfind("]") + 1
                raw_content = raw_content[start_idx:end_idx]
            
            raw_content = raw_content.strip()
            learning_steps = json.loads(raw_content)
            return learning_steps
            
        except json.JSONDecodeError as e:
            print(f"âŒ í•™ìŠµ ê²½ë¡œ JSON íŒŒì‹± ì˜¤ë¥˜: {e}")
            print(f"ğŸ” ë¬¸ì œê°€ ëœ ì‘ë‹µ: {raw_content}")
            # ê¸°ë³¸ í•™ìŠµ ê²½ë¡œ ë°˜í™˜
        except Exception as e:
            print(f"âŒ í•™ìŠµ ê²½ë¡œ ìƒì„± ì˜¤ë¥˜: {e}")
            # ê¸°ë³¸ í•™ìŠµ ê²½ë¡œ ë°˜í™˜
            # ê¸°ë³¸ í•™ìŠµ ê²½ë¡œ ë°˜í™˜ (ì—ëŸ¬ í•¸ë“¤ë§)
            return [
                {
                    "phase": "1ë‹¨ê³„: í˜„ì¬ ìŠ¤í‚¬ ê°•í™”",
                    "duration_weeks": duration_months * 4 // 3,
                    "objectives": ["ê¸°ì¡´ ê¸°ìˆ  ìŠ¤íƒ ì‹¬í™”"],
                    "resources": ["ì˜¨ë¼ì¸ ê°•ì˜", "ì‹¤ìŠµ í”„ë¡œì íŠ¸"],
                    "milestones": ["í”„ë¡œì íŠ¸ ì™„ì„±"]
                }
            ]

    def get_generation_metadata(self, process_type: str, start_time: float) -> Dict[str, Any]:
        """ìƒì„± ë©”íƒ€ë°ì´í„° (ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ìš©)"""
        return {
            "process_type": process_type,
            "model_used": self.model,
            "generation_time_seconds": round(time.time() - start_time, 2),
            "timestamp": time.strftime("%Y-%m-%d %H:%M:%S")
        }


# AI ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤ (ì‹±ê¸€í†¤)
career_coach_ai = CareerCoachAI()
